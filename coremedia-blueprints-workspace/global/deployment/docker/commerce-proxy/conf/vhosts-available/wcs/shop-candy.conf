<VirtualHost *:80 >
  ServerName candy-shop-preview-ibm.${ENVIRONMENT_FQDN}
  ServerAlias candy-shop-ibm.${ENVIRONMENT_FQDN}

  SetEnvIfNoCase Host candy-shop-preview-ibm.${ENVIRONMENT_FQDN} caeport=40980
  SetEnvIfNoCase Host candy-shop-ibm.${ENVIRONMENT_FQDN} caeport=42180
  SetEnvIfNoCase Host candy-shop-preview-production-ibm.${ENVIRONMENT_FQDN} caeport=40980

  SSLProxyEngine On
  SSLProxyVerify none
  SSLProxyCheckPeerCN off
  SSLProxyCheckPeerName off

  RewriteEngine On
  ProxyPreserveHost Off

  # extract the IP from Traefik to inject it into the fragmenthost header
  RemoteIPHeader X-REAL-IP
  SetEnvIf X-REAL-IP "(.*)" devaddr=$1
  SetEnvIF X-REAL-IP "(172.*)" devaddr=${ENVIRONMENT_FQDN}

  Header unset X-Frame-Options
  RequestHeader set X-FragmentHostDevelopment http://%{devaddr}e:%{caeport}e/blueprint/servlet/service/fragment/

  # CAE proxy
  <LocationMatch "^/(dynamic|service)/">
    # when requesting fragments from dynamic or service we need to switch of ProxyPreserveHost
    ProxyPreserveHost Off
  </LocationMatch>
  RewriteRule ^/(dynamic.*) http://%{devaddr}e:%{caeport}e/blueprint/servlet/dynamic/$1 [P,L]
  RewriteRule ^/(service.*) http://%{devaddr}e:%{caeport}e/blueprint/servlet/service/$1 [P,L]

  # WCS stores & search pass through WCS IHS(apache)
  RewriteRule ^/(.*) https://shop-preview-ibm.${WCS_HOST}/$1 [P,L]

</VirtualHost>
